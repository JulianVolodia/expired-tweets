<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>expired-tweets</title>

    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../node_modules/font-awesome/css/font-awesome.min.css">
    <script type="text/javascript" src="../node_modules/electron-open-link-in-browser/build/electron-open-link-in-browser.js"></script>
</head>
<body>
    <div class="container">
        <h1>expired-tweets</h1>
        <form>
            <label class="custom-file">
                <input type="file" id="choose-dir" class="custom-file-input" webkitdirectory directory>
                <span class="custom-file-control"></span>
            </label>
        </form>
        <hr />
        <table class="table table-bordered table-sm">
            <tr>
                <th>URL</th>
                <th>Expired</th>
                <th>Takeoverable</th>
                <th>Tweets</th>
            </tr>
        </table>
    </div>

    <script>
    (function() {
        var fileCaption = document.createElement('style');
        var username = "";
        document.head.appendChild(fileCaption);

        var table = document.querySelector("table tbody") || document.querySelector("table");

        document.getElementById('choose-dir').addEventListener('change', function(e) {
            if(e.isTrusted && e.target) {
                if(e.target.files) {
                    fileCaption.innerHTML = ".custom-file-control::after{content:'" + e.target.files[0].name.replace(/'/g, '&#039;') + "' !important;}";

                    var path = e.target.files[0].path;
                    path = path.indexOf('data/js/tweets') > -1 ? path : path + '/data/js/tweets';
                    var et = require('../index.js');

                    var expiredTweets = new et({
                        dir: path
                    });

                    expiredTweets.run();

                    expiredTweets.on('data', function(data) {
                        if (data.domain) {
                            var row = document.querySelector('[data-domain="' + data.domain + '"]');
                            if (!row) {
                                table.innerHTML += "<tr data-domain=\"" + data.domain.replace(/"/g, '&quot;') + "\"><td>" + data.domain.replace(/"/g, '&quot;') + "</td><td></td><td></td><td><a href=\"https://twitter.com/search?f=tweets&q=from%3A" + username + "%20filter%3Alinks%20" + data.domain.replace(/"/g, '&quot;') + "\" onclick=\"electronOpenLinkInBrowser()\">Open</a></td></tr>";
                                row = document.querySelector('[data-domain="' + data.domain + '"]');
                            }

                            if (data.type === 'whois') {
                                if (data.data === -1) {
                                    row.querySelectorAll('td')[1].innerHTML += "<i class=\"fa fa-check\" style=\"color: #f00\"></i>";
                                    row.classList.add('table-danger');
                                } else {
                                    var expires = new Date(data.data) - Date.now();

                                    console.log(expires, data);

                                    if (expires < 0) {
                                        row.querySelectorAll('td')[1].innerHTML += "<i class=\"fa fa-check\" style=\"color: #f00\"></i>";
                                        row.classList.add('table-danger');
                                    } else if (expires < 1000 * 60 * 60 * 24 * 3) {
                                        row.querySelectorAll('td')[1].innerHTML += "<i class=\"fa fa-exlamation\" style=\"color: #ffa500\"></i>";
                                        if(!row.classList.contains('table-danger')) row.classList.add('table-warning');
                                    } else {
                                        row.querySelectorAll('td')[1].innerHTML += "<i class=\"fa fa-times\" style=\"color: #32cd32\"></i>";
                                    }
                                }
                            } else if (data.type === 'takeover') {
                                if (data.data === false) {
                                    row.querySelectorAll('td')[2].innerHTML += "<i class=\"fa fa-times\" style=\"color: #32cd32\"></i>";
                                } else if (data.data === 'warning') {
                                    row.querySelectorAll('td')[2].innerHTML += "<i class=\"fa fa-exclamation-triangle\" style=\"color: #ffa500\"></i>";
                                } else {
                                    row.querySelectorAll('td')[2].innerHTML += "<i class=\"fa fa-check\" style=\"color: #f00\" title=\"" + data.data + "\"></i>";
                                    row.classList.add('table-danger');
                                }
                            }
                        }
                    });

                    expiredTweets.on('username', function(_username) {
                        username = _username;
                    });

                    expiredTweets.on('error', console.error);
                } else {
                    fileCaption.innerHTML = '';
                }
            }
        });
    })();
    </script>
</body>
</html>